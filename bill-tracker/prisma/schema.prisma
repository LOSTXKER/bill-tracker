generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id            String          @id
  companyId     String
  code          String
  name          String
  nameTh        String?
  class         AccountClass
  parentId      String?
  description   String?
  keywords      String[]
  isActive      Boolean         @default(true)
  isSystem      Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  source        DataSource      @default(MANUAL)
  Company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Account       Account?        @relation("AccountToAccount", fields: [parentId], references: [id])
  other_Account Account[]       @relation("AccountToAccount")
  Expense       Expense[]
  Income        Income[]
  VendorMapping VendorMapping[]

  @@unique([companyId, code])
  @@index([companyId, class])
  @@index([companyId, isActive])
}

model AuditLog {
  id          String      @id
  userId      String
  action      AuditAction
  entityType  String
  entityId    String
  changes     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  companyId   String?
  description String?
  User        User        @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
}

model Comment {
  id                     String                @id
  expenseId              String?
  incomeId               String?
  reimbursementRequestId String?
  content                String
  parentId               String?
  mentionedUserIds       Json                  @default("[]")
  authorId               String
  isResolved             Boolean               @default(false)
  resolvedAt             DateTime?
  resolvedBy             String?
  deletedAt              DateTime?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime
  User                   User                  @relation(fields: [authorId], references: [id])
  Expense                Expense?              @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  Income                 Income?               @relation(fields: [incomeId], references: [id], onDelete: Cascade)
  Comment                Comment?              @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  other_Comment          Comment[]             @relation("CommentToComment")
  ReimbursementRequest   ReimbursementRequest? @relation(fields: [reimbursementRequestId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([expenseId])
  @@index([incomeId])
  @@index([parentId])
  @@index([reimbursementRequestId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Company {
  id                         String                 @id
  name                       String
  code                       String                 @unique
  taxId                      String?
  address                    String?
  phone                      String?
  logoUrl                    String?
  createdAt                  DateTime               @default(now())
  updatedAt                  DateTime
  aiConfig                   Json?
  lineChannelAccessToken     String?
  lineChannelSecret          String?
  lineGroupId                String?
  lineNotifyEnabled          Boolean                @default(true)
  lineNotifySettings         Json                   @default("{}")
  exchangeRates              Json                   @default("{}")
  reimbursementSpendingLimit Decimal?               @db.Decimal(12, 2)
  lastAccountImportAt        DateTime?
  lastContactImportAt        DateTime?
  docReminderDays            Int                    @default(7)
  docReminderEnabled         Boolean                @default(true)
  whtDeadlineDay             Int                    @default(7)
  whtReminderDays            Int                    @default(3)
  whtReminderEnabled         Boolean                @default(true)
  businessDescription        String?
  Account                    Account[]
  CompanyAccess              CompanyAccess[]
  Contact                    Contact[]
  Expense                    Expense[]
  Income                     Income[]
  Integration                Integration[]
  RecurringExpense           RecurringExpense[]
  ReimbursementRequest       ReimbursementRequest[]
  VendorMapping              VendorMapping[]
  PettyCashFund              PettyCashFund[]

  @@index([code])
}

model CompanyAccess {
  id          String   @id
  userId      String
  companyId   String
  createdAt   DateTime @default(now())
  isOwner     Boolean  @default(false)
  permissions Json     @default("[]")
  updatedAt   DateTime @default(now())
  Company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([companyId])
  @@index([userId])
}

model Contact {
  id                   String                 @id
  companyId            String
  name                 String
  taxId                String?
  address              String?
  phone                String?
  email                String?
  bankAccount          String?
  bankName             String?
  creditLimit          Decimal?               @db.Decimal(12, 2)
  paymentTerms         Int?
  notes                String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  branchCode           String?                @default("00000")
  type                 ContactType            @default(COMPANY)
  peakCode             String?
  contactCategory      ContactCategory        @default(VENDOR)
  entityType           EntityType             @default(COMPANY)
  businessType         String?
  nationality          String?                @default("ไทย")
  prefix               String?
  firstName            String?
  lastName             String?
  subDistrict          String?
  district             String?
  province             String?
  postalCode           String?
  country              String?                @default("Thailand")
  contactPerson        String?
  source               DataSource             @default(MANUAL)
  Company              Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Expense              Expense[]
  Income               Income[]
  ReimbursementRequest ReimbursementRequest[]
  VendorMapping        VendorMapping[]

  @@unique([companyId, peakCode])
  @@index([companyId])
  @@index([name])
  @@index([taxId])
}

model DocumentEvent {
  id         String            @id
  expenseId  String?
  incomeId   String?
  eventType  DocumentEventType
  eventDate  DateTime          @default(now())
  fromStatus String?
  toStatus   String?
  notes      String?
  metadata   Json?
  createdBy  String
  createdAt  DateTime          @default(now())
  User       User              @relation(fields: [createdBy], references: [id])
  Expense    Expense?          @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  Income     Income?           @relation(fields: [incomeId], references: [id], onDelete: Cascade)

  @@index([eventDate])
  @@index([eventType])
  @@index([expenseId])
  @@index([incomeId])
}

model Expense {
  id                                         String                @id
  companyId                                  String
  amount                                     Decimal               @db.Decimal(12, 2)
  vatRate                                    Int                   @default(7)
  vatAmount                                  Decimal?              @db.Decimal(12, 2)
  isWht                                      Boolean               @default(false)
  whtRate                                    Decimal?              @db.Decimal(5, 2)
  whtAmount                                  Decimal?              @db.Decimal(12, 2)
  whtType                                    WhtType?
  netPaid                                    Decimal               @db.Decimal(12, 2)
  description                                String?
  invoiceNumber                              String?
  referenceNo                                String?
  paymentMethod                              PaymentMethod         @default(BANK_TRANSFER)
  billDate                                   DateTime              @default(now())
  dueDate                                    DateTime?
  status                                     ExpenseDocStatus      @default(PENDING_PHYSICAL)
  notes                                      String?
  approvedBy                                 String?
  approvedAt                                 DateTime?
  createdBy                                  String
  createdAt                                  DateTime              @default(now())
  updatedAt                                  DateTime
  contactId                                  String?
  slipUrls                                   Json                  @default("[]")
  taxInvoiceUrls                             Json                  @default("[]")
  whtCertUrls                                Json                  @default("[]")
  deletedAt                                  DateTime?
  deletedBy                                  String?
  fraudAnalyzedAt                            DateTime?
  fraudFlags                                 Json?
  fraudScore                                 Int?
  isReimbursement                            Boolean               @default(false)
  reimbursementApprovedAt                    DateTime?
  reimbursementApprovedBy                    String?
  reimbursementPaidAt                        DateTime?
  reimbursementPaidBy                        String?
  reimbursementPaymentRef                    String?
  reimbursementRejectedReason                String?
  reimbursementStatus                        ReimbursementStatus?
  requesterId                                String?
  contactName                                String?
  accountId                                  String?
  hasTaxInvoice                              Boolean               @default(false)
  hasWhtCert                                 Boolean               @default(false)
  documentType                               ExpenseDocumentType   @default(TAX_INVOICE)
  sentToAccountAt                            DateTime?
  taxInvoiceAt                               DateTime?
  whtCertIssuedAt                            DateTime?
  whtCertSentAt                              DateTime?
  workflowStatus                             ExpenseWorkflowStatus @default(DRAFT)
  referenceUrls                              Json                  @default("[]")
  // Approval workflow fields
  approvalStatus                             ApprovalStatus        @default(NOT_REQUIRED)
  rejectedReason                             String?
  submittedAt                                DateTime?
  submittedBy                                String?
  Comment                                    Comment[]
  DocumentEvent                              DocumentEvent[]
  Account                                    Account?              @relation(fields: [accountId], references: [id])
  Company                                    Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Contact                                    Contact?              @relation(fields: [contactId], references: [id])
  User_Expense_createdByToUser               User                  @relation("Expense_createdByToUser", fields: [createdBy], references: [id])
  User_Expense_reimbursementApprovedByToUser User?                 @relation("Expense_reimbursementApprovedByToUser", fields: [reimbursementApprovedBy], references: [id])
  User_Expense_reimbursementPaidByToUser     User?                 @relation("Expense_reimbursementPaidByToUser", fields: [reimbursementPaidBy], references: [id])
  User_Expense_requesterIdToUser             User?                 @relation("Expense_requesterIdToUser", fields: [requesterId], references: [id])
  User_Expense_submittedByToUser             User?                 @relation("Expense_submittedByToUser", fields: [submittedBy], references: [id])
  ReimbursementRequest                       ReimbursementRequest?
  ExpensePayments                            ExpensePayment[]
  PettyCashTransactions                      PettyCashTransaction[]

  @@index([accountId])
  @@index([companyId, billDate])
  @@index([contactId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([isReimbursement, reimbursementStatus])
  @@index([requesterId])
  @@index([status])
  @@index([workflowStatus])
  @@index([approvalStatus])
}

model Income {
  id                 String               @id
  companyId          String
  amount             Decimal              @db.Decimal(12, 2)
  vatRate            Int                  @default(0)
  vatAmount          Decimal?             @db.Decimal(12, 2)
  isWhtDeducted      Boolean              @default(false)
  whtRate            Decimal?             @db.Decimal(5, 2)
  whtAmount          Decimal?             @db.Decimal(12, 2)
  whtType            WhtType?
  netReceived        Decimal              @db.Decimal(12, 2)
  source             String?
  invoiceNumber      String?
  referenceNo        String?
  paymentMethod      PaymentMethod        @default(BANK_TRANSFER)
  receiveDate        DateTime             @default(now())
  status             IncomeDocStatus      @default(PENDING_COPY_SEND)
  notes              String?
  jobOrderId         String?
  createdBy          String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  contactId          String?
  customerSlipUrls   Json                 @default("[]")
  myBillCopyUrls     Json                 @default("[]")
  whtCertUrls        Json                 @default("[]")
  deletedAt          DateTime?
  deletedBy          String?
  contactName        String?
  accountId          String?
  hasInvoice         Boolean              @default(false)
  hasWhtCert         Boolean              @default(false)
  invoiceIssuedAt    DateTime?
  invoiceSentAt      DateTime?
  sentToAccountAt    DateTime?
  whtCertReceivedAt  DateTime?
  whtCertRemindCount Int                  @default(0)
  whtCertRemindedAt  DateTime?
  workflowStatus     IncomeWorkflowStatus @default(DRAFT)
  referenceUrls      Json                 @default("[]")
  // Approval workflow fields
  approvalStatus     ApprovalStatus       @default(NOT_REQUIRED)
  rejectedReason     String?
  submittedAt        DateTime?
  submittedBy        String?
  approvedBy         String?
  approvedAt         DateTime?
  Comment            Comment[]
  DocumentEvent      DocumentEvent[]
  Account            Account?             @relation(fields: [accountId], references: [id])
  Company            Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Contact            Contact?             @relation(fields: [contactId], references: [id])
  User               User                 @relation("Income_createdByToUser", fields: [createdBy], references: [id])
  User_Income_submittedByToUser  User?    @relation("Income_submittedByToUser", fields: [submittedBy], references: [id])
  User_Income_approvedByToUser   User?    @relation("Income_approvedByToUser", fields: [approvedBy], references: [id])

  @@index([accountId])
  @@index([companyId, receiveDate])
  @@index([contactId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([status])
  @@index([workflowStatus])
  @@index([approvalStatus])
}

model Integration {
  id             String          @id
  companyId      String
  type           IntegrationType
  name           String
  config         Json
  isActive       Boolean         @default(true)
  lastSyncAt     DateTime?
  lastSyncStatus String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  Company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, type])
}

model Notification {
  id            String           @id
  companyId     String
  targetUserIds Json             @default("[]")
  type          NotificationType
  entityType    String
  entityId      String
  title         String
  message       String
  actorId       String?
  actorName     String?
  readBy        Json             @default("{}")
  metadata      Json?
  createdAt     DateTime         @default(now())

  @@index([companyId, createdAt])
  @@index([entityType, entityId])
}

model RecurringExpense {
  id            String         @id
  companyId     String
  name          String
  templateData  Json
  frequency     RecurrenceFreq
  amount        Decimal        @db.Decimal(12, 2)
  nextDueDate   DateTime
  lastCreatedAt DateTime?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  Company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, nextDueDate])
  @@index([isActive])
}

model ReimbursementRequest {
  id                                         String              @id
  companyId                                  String
  amount                                     Decimal             @db.Decimal(12, 2)
  vatRate                                    Int                 @default(7)
  vatAmount                                  Decimal?            @db.Decimal(12, 2)
  netAmount                                  Decimal             @db.Decimal(12, 2)
  description                                String?
  contactId                                  String?
  invoiceNumber                              String?
  paymentMethod                              PaymentMethod       @default(CASH)
  billDate                                   DateTime            @default(now())
  receiptUrls                                Json                @default("[]")
  status                                     ReimbursementStatus @default(PENDING)
  approvedBy                                 String?
  approvedAt                                 DateTime?
  rejectedReason                             String?
  paidAt                                     DateTime?
  paidBy                                     String?
  paymentRef                                 String?
  linkedExpenseId                            String?             @unique
  fraudScore                                 Int?
  fraudFlags                                 Json?
  fraudAnalyzedAt                            DateTime?
  createdAt                                  DateTime            @default(now())
  updatedAt                                  DateTime
  // User who submitted the request (required)
  requesterId                                String
  requesterName                              String              @default("")
  requesterPhone                             String?
  requesterEmail                             String?
  bankName                                   String              @default("")
  bankAccountNo                              String              @default("")
  bankAccountName                            String              @default("")
  // DEPRECATED: trackingCode no longer needed (kept for backward compatibility)
  trackingCode                               String?             @unique
  referenceUrls                              Json                @default("[]")
  Comment                                    Comment[]
  User_ReimbursementRequest_approvedByToUser User?               @relation("ReimbursementRequest_approvedByToUser", fields: [approvedBy], references: [id])
  Company                                    Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Contact                                    Contact?            @relation(fields: [contactId], references: [id])
  Expense                                    Expense?            @relation(fields: [linkedExpenseId], references: [id])
  User_ReimbursementRequest_paidByToUser     User?               @relation("ReimbursementRequest_paidByToUser", fields: [paidBy], references: [id])
  Requester                                  User                @relation("ReimbursementRequest_requester", fields: [requesterId], references: [id])

  @@index([companyId, status])
  @@index([createdAt])
  @@index([trackingCode])
  @@index([requesterId])
}

model ExpensePayment {
  id                    String           @id @default(cuid())
  expenseId             String
  paidByType            PaidByType
  paidByUserId          String?          // Required when paidByType = USER
  paidByPettyCashFundId String?          // Required when paidByType = PETTY_CASH
  // DEPRECATED: These fields were for EXTERNAL payers (kept for migration compatibility)
  paidByName            String?
  paidByBankName        String?
  paidByBankAccount     String?
  amount                Decimal          @db.Decimal(12, 2)
  settlementStatus      SettlementStatus @default(NOT_REQUIRED)
  settledAt             DateTime?
  settledBy             String?
  settlementRef         String?
  settlementSlipUrls    Json             @default("[]")
  // Reversal fields (when SETTLED -> REVERSED)
  reversedAt            DateTime?
  reversedBy            String?
  reversalReason        String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  Expense               Expense          @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  PaidByUser            User?            @relation("ExpensePayment_paidBy", fields: [paidByUserId], references: [id])
  SettledByUser         User?            @relation("ExpensePayment_settledBy", fields: [settledBy], references: [id])
  ReversedByUser        User?            @relation("ExpensePayment_reversedBy", fields: [reversedBy], references: [id])
  PettyCashFund         PettyCashFund?   @relation(fields: [paidByPettyCashFundId], references: [id])

  @@index([expenseId])
  @@index([paidByUserId])
  @@index([paidByPettyCashFundId])
  @@index([settlementStatus])
  @@index([paidByType, settlementStatus])
}

model User {
  id                                                         String                 @id
  email                                                      String                 @unique
  name                                                       String
  password                                                   String
  role                                                       UserRole               @default(STAFF)
  isActive                                                   Boolean                @default(true)
  lastLoginAt                                                DateTime?
  avatarUrl                                                  String?
  createdAt                                                  DateTime               @default(now())
  updatedAt                                                  DateTime
  AuditLog                                                   AuditLog[]
  Comment                                                    Comment[]
  CompanyAccess                                              CompanyAccess[]
  DocumentEvent                                              DocumentEvent[]
  Expense_Expense_createdByToUser                            Expense[]              @relation("Expense_createdByToUser")
  Expense_Expense_reimbursementApprovedByToUser              Expense[]              @relation("Expense_reimbursementApprovedByToUser")
  Expense_Expense_reimbursementPaidByToUser                  Expense[]              @relation("Expense_reimbursementPaidByToUser")
  Expense_Expense_requesterIdToUser                          Expense[]              @relation("Expense_requesterIdToUser")
  Expense_Expense_submittedByToUser                          Expense[]              @relation("Expense_submittedByToUser")
  Income_Income_createdByToUser                              Income[]               @relation("Income_createdByToUser")
  Income_Income_submittedByToUser                            Income[]               @relation("Income_submittedByToUser")
  Income_Income_approvedByToUser                             Income[]               @relation("Income_approvedByToUser")
  ReimbursementRequest_ReimbursementRequest_approvedByToUser ReimbursementRequest[] @relation("ReimbursementRequest_approvedByToUser")
  ReimbursementRequest_ReimbursementRequest_paidByToUser     ReimbursementRequest[] @relation("ReimbursementRequest_paidByToUser")
  ReimbursementRequest_requester                             ReimbursementRequest[] @relation("ReimbursementRequest_requester")
  ExpensePayments_paidBy                                     ExpensePayment[]       @relation("ExpensePayment_paidBy")
  ExpensePayments_settledBy                                  ExpensePayment[]       @relation("ExpensePayment_settledBy")
  ExpensePayments_reversedBy                                 ExpensePayment[]       @relation("ExpensePayment_reversedBy")
  PettyCashFunds_custodian                                   PettyCashFund[]        @relation("PettyCashFund_custodian")
  PettyCashTransactions                                      PettyCashTransaction[] @relation("PettyCashTransaction_createdBy")

  @@index([email])
}

model VendorMapping {
  id                  String         @id
  companyId           String
  vendorName          String?
  vendorTaxId         String?
  namePattern         String?
  contactId           String?
  defaultVatRate      Int?
  paymentMethod       PaymentMethod?
  descriptionTemplate String?
  useCount            Int            @default(0)
  lastUsedAt          DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime
  transactionType     String
  learnSource         String?
  originalTxId        String?
  accountId           String?
  defaultWhtRate      Int?
  defaultWhtType      String?
  Account             Account?       @relation(fields: [accountId], references: [id])
  Company             Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Contact             Contact?       @relation(fields: [contactId], references: [id])

  @@unique([companyId, vendorTaxId, transactionType])
  @@index([companyId, transactionType])
  @@index([companyId, vendorName])
}

enum AccountClass {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  COST_OF_SALES
  EXPENSE
  OTHER_INCOME
  OTHER_EXPENSE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  APPROVE
  EXPORT
}

enum ContactCategory {
  CUSTOMER
  VENDOR
  BOTH
  OTHER
}

enum ContactType {
  INDIVIDUAL
  COMPANY
}

enum DataSource {
  MANUAL
  PEAK
}

enum DocumentEventType {
  CREATED
  UPDATED
  STATUS_CHANGED
  FILE_UPLOADED
  FILE_REMOVED
  NOTE_ADDED
  TAX_INVOICE_REQUESTED
  TAX_INVOICE_RECEIVED
  INVOICE_ISSUED
  INVOICE_SENT
  WHT_CERT_ISSUED
  WHT_CERT_SENT
  WHT_CERT_RECEIVED
  WHT_REMINDER_SENT
  SENT_TO_ACCOUNTANT
  ACCOUNTANT_CONFIRMED
  // Approval workflow events
  SUBMITTED_FOR_APPROVAL
  APPROVED
  REJECTED
  MARKED_AS_PAID
}

enum EntityType {
  INDIVIDUAL
  COMPANY
}

enum ExpenseDocStatus {
  WAITING_FOR_DOC
  PENDING_PHYSICAL
  READY_TO_SEND
  SENT_TO_ACCOUNT
}

enum ExpenseDocumentType {
  TAX_INVOICE   // ใบกำกับภาษี (VAT 7%)
  CASH_RECEIPT  // บิลเงินสด (VAT 0%)
  NO_DOCUMENT   // ไม่มีเอกสาร (VAT 0%)
}

enum ExpenseWorkflowStatus {
  DRAFT
  PAID
  WAITING_TAX_INVOICE
  TAX_INVOICE_RECEIVED
  WHT_PENDING_ISSUE
  WHT_ISSUED
  WHT_SENT_TO_VENDOR
  READY_FOR_ACCOUNTING
  SENT_TO_ACCOUNTANT
  COMPLETED
}

enum IncomeDocStatus {
  NO_DOC_REQUIRED
  WAITING_ISSUE
  WAITING_WHT_CERT
  PENDING_COPY_SEND
  SENT_COPY
}

enum IncomeWorkflowStatus {
  DRAFT
  RECEIVED
  NO_INVOICE_NEEDED
  WAITING_INVOICE_ISSUE
  INVOICE_ISSUED
  INVOICE_SENT
  WHT_PENDING_CERT
  WHT_CERT_RECEIVED
  READY_FOR_ACCOUNTING
  SENT_TO_ACCOUNTANT
  COMPLETED
}

enum IntegrationType {
  ACCOUNTING_SOFTWARE
  BANK_STATEMENT
  PAYMENT_GATEWAY
  LINE_NOTIFY
  GOOGLE_DRIVE
}

enum NotificationType {
  TRANSACTION_CREATED
  TRANSACTION_UPDATED
  TRANSACTION_DELETED
  TRANSACTION_STATUS_CHANGED
  TRANSACTION_SUBMITTED       // ส่งคำขออนุมัติ
  TRANSACTION_APPROVED        // อนุมัติรายการ
  TRANSACTION_REJECTED        // ปฏิเสธรายการ
  FILE_UPLOADED
  REIMBURSEMENT_SUBMITTED
  REIMBURSEMENT_APPROVED
  REIMBURSEMENT_REJECTED
  REIMBURSEMENT_PAID
  REMINDER
  COMMENT_ADDED
  COMMENT_REPLY
  COMMENT_MENTION
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  PROMPTPAY
  CHEQUE
}

enum RecurrenceFreq {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum ReimbursementStatus {
  PENDING
  FLAGGED
  APPROVED
  REJECTED
  PAID
}

enum ApprovalStatus {
  NOT_REQUIRED  // ไม่ต้องอนุมัติ (สร้างโดยคนมีสิทธิ์ create-direct)
  PENDING       // รออนุมัติ
  APPROVED      // อนุมัติแล้ว
  REJECTED      // ถูกปฏิเสธ
}

enum UserRole {
  ADMIN
  ACCOUNTANT
  STAFF
  VIEWER
}

enum WhtType {
  SERVICE_3
  PROFESSIONAL_5
  TRANSPORT_1
  RENT_5
  ADVERTISING_2
  OTHER
}

enum PaidByType {
  COMPANY
  PETTY_CASH
  USER
  // EXTERNAL removed - all payers must have user accounts
}

enum SettlementStatus {
  NOT_REQUIRED
  PENDING
  SETTLED
  REVERSED // ยกเลิกการโอนคืน (สำหรับกรณีบันทึกผิด)
}

// =============================================================================
// Petty Cash Management
// =============================================================================

model PettyCashFund {
  id            String                 @id @default(cuid())
  companyId     String
  name          String                 // ชื่อกองทุน เช่น "เงินสดย่อยสำนักงาน"
  initialAmount Decimal                @db.Decimal(12, 2) // ยอดตั้งต้น
  currentAmount Decimal                @db.Decimal(12, 2) // ยอดคงเหลือปัจจุบัน
  lowThreshold  Decimal?               @db.Decimal(12, 2) // ยอดขั้นต่ำที่ต้องเตือน
  custodianId   String?                // ผู้ดูแลกองทุน
  isActive      Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  Company         Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  Custodian       User?                  @relation("PettyCashFund_custodian", fields: [custodianId], references: [id])
  Transactions    PettyCashTransaction[]
  ExpensePayments ExpensePayment[]

  @@index([companyId])
  @@index([custodianId])
}

model PettyCashTransaction {
  id          String                   @id @default(cuid())
  fundId      String
  type        PettyCashTransactionType
  amount      Decimal                  @db.Decimal(12, 2)
  expenseId   String?                  // ถ้าเป็นการจ่ายจากรายจ่าย
  description String?
  createdBy   String
  createdAt   DateTime                 @default(now())

  Fund        PettyCashFund            @relation(fields: [fundId], references: [id], onDelete: Cascade)
  Expense     Expense?                 @relation(fields: [expenseId], references: [id])
  User        User                     @relation("PettyCashTransaction_createdBy", fields: [createdBy], references: [id])

  @@index([fundId])
  @@index([expenseId])
  @@index([createdAt])
}

enum PettyCashTransactionType {
  EXPENSE     // จ่ายออก (ตัดจากรายจ่าย)
  REPLENISH   // เติมเงิน
  ADJUSTMENT  // ปรับยอด (เช่น นับเงินสดได้ไม่ตรง)
}
