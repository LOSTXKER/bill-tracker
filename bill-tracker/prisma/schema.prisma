// Bill Tracker & Mini-ERP System
// Database schema for Anajak T-Shirt & Meelike-th

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// Core Business Entities
// =============================================================================

model Company {
  id      String  @id @default(cuid())
  name    String // "Anajak T-Shirt", "Meelike-th"
  code    String  @unique // "ANJ", "MLK"
  taxId   String? // ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ
  address String?
  phone   String?
  logoUrl String?

  // LINE Bot Configuration
  lineChannelSecret      String?  // LINE Bot Channel Secret
  lineChannelAccessToken String?  // LINE Bot Channel Access Token
  lineGroupId            String?  // LINE Group ID (auto-filled by bot)
  lineNotifyEnabled      Boolean  @default(true) // Enable/disable LINE notifications
  lineNotifySettings     Json     @default("{}") // Detailed notification settings

  // AI Configuration
  aiConfig Json? // AI preferences and settings

  // Exchange Rates Configuration (currency code to THB rate)
  // Example: { "USD": 35.50, "AED": 9.65 }
  exchangeRates Json @default("{}") // Currency exchange rates to THB

  // Reimbursement Settings
  reimbursementSpendingLimit Decimal? @db.Decimal(12, 2) // ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á (null = ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î)

  // Chart of Accounts Sync
  lastAccountImportAt DateTime? // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà import ‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  
  // Contacts Sync
  lastContactImportAt DateTime? // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà import ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Peak

  // WHT Settings
  whtDeadlineDay      Int     @default(7)   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≥‡∏™‡πà‡∏á WHT (1-28)
  whtReminderDays     Int     @default(3)   // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô deadline
  docReminderDays     Int     @default(7)   // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô
  whtReminderEnabled  Boolean @default(true) // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô WHT
  docReminderEnabled  Boolean @default(true) // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á

  // Relations
  expenses              Expense[]
  incomes               Income[]
  users                 CompanyAccess[]
  contacts              Contact[]
  accounts              Account[]
  integrations          Integration[]
  recurringExpenses     RecurringExpense[]
  vendorMappings        VendorMapping[]
  reimbursementRequests ReimbursementRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

// =============================================================================
// User Management with RBAC
// =============================================================================

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String
  password    String // hashed with bcrypt
  role        UserRole  @default(STAFF)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  avatarUrl   String?

  // Relations
  companies CompanyAccess[]
  expenses  Expense[]       @relation("ExpenseCreator")
  incomes   Income[]        @relation("IncomeCreator")
  auditLogs AuditLog[]

  // Reimbursement Relations (Legacy - for old Expense-based reimbursements)
  reimbursementRequests  Expense[] @relation("ReimbursementRequester")
  reimbursementApprovals Expense[] @relation("ReimbursementApprover")
  reimbursementPayments  Expense[] @relation("ReimbursementPayer")

  // New ReimbursementRequest Relations (Admin only - no requester)
  myReimbursementApprovals      ReimbursementRequest[] @relation("ReimbursementApprovals")
  myReimbursementPayments       ReimbursementRequest[] @relation("ReimbursementPayments")
  
  // Document Events
  documentEvents                DocumentEvent[] @relation("DocumentEventCreator")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

enum UserRole {
  ADMIN // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ
  ACCOUNTANT // ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ expense/income ‡πÑ‡∏î‡πâ
  STAFF // ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ
  VIEWER // ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
}

model CompanyAccess {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Custom Permission System
  isOwner     Boolean @default(false) // OWNER flag - ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
  permissions Json    @default("[]") // Custom permissions array: ["expenses:*", "incomes:read", ...]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}


// =============================================================================
// Data Source (‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
// =============================================================================

enum DataSource {
  MANUAL    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
  PEAK      // Import ‡∏à‡∏≤‡∏Å Peak
}

// =============================================================================
// Account (‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - Chart of Accounts)
// =============================================================================

enum AccountClass {
  ASSET           // 1 - ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
  LIABILITY       // 2 - ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô
  EQUITY          // 3 - ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
  REVENUE         // 4 - ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
  COST_OF_SALES   // 5 - ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢
  EXPENSE         // 6 - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏£‡∏∑‡∏≠ 5x ‡πÉ‡∏ô PEAK)
  OTHER_INCOME    // 7 - ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô
  OTHER_EXPENSE   // 8 - ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô
}

model Account {
  id          String       @id @default(cuid())
  companyId   String
  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  code        String       // "530306" - ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ PEAK
  name        String       // "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î"
  nameTh      String?      // ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å name)
  
  class       AccountClass // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å
  parentId    String?      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sub-account
  parent      Account?     @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Account[]    @relation("AccountHierarchy")
  
  description String?      // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
  keywords    String[]     // ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI ‡πÄ‡∏ä‡πà‡∏ô ["‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î", "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ", "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå"]
  
  isActive    Boolean      @default(true)
  isSystem    Boolean      @default(false)  // ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ
  source      DataSource   @default(MANUAL) // ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤: MANUAL = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á, PEAK = import ‡∏à‡∏≤‡∏Å Peak
  
  // Relations
  expenses       Expense[]
  incomes        Income[]
  vendorMappings VendorMapping[]
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@unique([companyId, code])
  @@index([companyId, class])
  @@index([companyId, isActive])
}

// =============================================================================
// Contact (‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ - ‡∏£‡∏ß‡∏° Vendor ‡πÅ‡∏•‡∏∞ Customer)
// =============================================================================

enum ContactType {
  INDIVIDUAL  // ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ -> ‡∏†.‡∏á.‡∏î.3
  COMPANY     // ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• -> ‡∏†.‡∏á.‡∏î.53
}

enum ContactCategory {
  CUSTOMER  // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  VENDOR    // ‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
  BOTH      // ‡∏ó‡∏±‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
  OTHER     // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
}

enum EntityType {
  INDIVIDUAL  // ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
  COMPANY     // ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
}

model Contact {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Peak sync
  peakCode      String?   @unique // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Peak (C00001, C00002...)
  source        DataSource @default(MANUAL) // ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤: MANUAL = ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á, PEAK = import ‡∏à‡∏≤‡∏Å Peak
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
  contactCategory ContactCategory @default(VENDOR) // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢/‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  entityType      EntityType @default(COMPANY) // ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤/‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
  businessType    String? // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£ (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏≥‡∏Å‡∏±‡∏î, ‡∏´‡πâ‡∏≤‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô...)
  nationality     String? @default("‡πÑ‡∏ó‡∏¢") // ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥
  
  // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å fields
  prefix        String? // ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏ô‡∏≤‡∏¢, ‡∏ô‡∏≤‡∏á, ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)
  firstName     String? // ‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤)
  lastName      String? // ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
  name          String  // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°/‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (required)
  
  // Keep old field for backward compatibility (deprecated)
  type       ContactType @default(COMPANY) // ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (deprecated, use entityType)
  
  taxId      String?
  branchCode String?     @default("00000") // ‡πÄ‡∏•‡∏Ç‡∏™‡∏≤‡∏Ç‡∏≤ 5 ‡∏´‡∏•‡∏±‡∏Å
  
  // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏¢‡∏Å fields
  address       String? // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡∏ã‡∏≠‡∏¢ ‡∏ñ‡∏ô‡∏ô)
  subDistrict   String? // ‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•
  district      String? // ‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
  province      String? // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
  postalCode    String? // ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
  country       String? @default("Thailand")
  
  // ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
  contactPerson String? // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
  phone         String?
  email         String?

  // Banking
  bankAccount String?
  bankName    String?

  // Business Terms
  creditLimit  Decimal? @db.Decimal(12, 2)
  paymentTerms Int? // ‡∏ß‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï

  notes String?

  // Relations
  expenses              Expense[]
  incomes               Income[]
  vendorMappings        VendorMapping[]
  reimbursementRequests ReimbursementRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([name])
  @@index([taxId])
  @@index([peakCode])
}

// =============================================================================
// Expense (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢) - Enhanced
// =============================================================================

model Expense {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Contact Information (‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  contactName String? // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (one-time contact)

  // Financial Data
  amount    Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT
  vatRate   Int      @default(7) // 7% ‡∏´‡∏£‡∏∑‡∏≠ 0%
  vatAmount Decimal? @db.Decimal(12, 2)

  // WHT (‡πÄ‡∏£‡∏≤‡∏´‡∏±‡∏Å‡πÄ‡∏Ç‡∏≤)
  isWht     Boolean  @default(false)
  whtRate   Decimal? @db.Decimal(5, 2) // 1, 2, 3, 5, 10
  whtAmount Decimal? @db.Decimal(12, 2)
  whtType   WhtType? // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ
  netPaid   Decimal  @db.Decimal(12, 2) // Amount + VAT - WHT

  // Document Details
  description   String?
  accountId     String?          // Chart of Accounts
  account       Account?         @relation(fields: [accountId], references: [id])
  invoiceNumber String? // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
  referenceNo   String? // ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á transaction
  paymentMethod PaymentMethod    @default(BANK_TRANSFER)

  // Evidence Files (Supabase Storage URLs - Multiple Files)
  slipUrls       Json @default("[]") // Array of slip URLs
  taxInvoiceUrls Json @default("[]") // Array of tax invoice URLs
  whtCertUrls    Json @default("[]") // Array of WHT cert URLs

  // Dates
  billDate DateTime  @default(now()) // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
  dueDate  DateTime? // ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)

  // Status & Workflow (Legacy)
  status ExpenseDocStatus @default(PENDING_PHYSICAL)
  notes  String?          @db.Text

  // NEW: Workflow Status (Timeline-based)
  workflowStatus    ExpenseWorkflowStatus @default(PAID)
  
  // NEW: Document Checklist
  hasTaxInvoice     Boolean   @default(false)  // ‡∏°‡∏µ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
  taxInvoiceAt      DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö
  
  hasWhtCert        Boolean   @default(false)  // ‡∏°‡∏µ‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥ (‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÄ‡∏£‡∏≤)
  whtCertIssuedAt   DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  whtCertSentAt     DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥‡πÉ‡∏´‡πâ vendor
  
  sentToAccountAt   DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  
  // NEW: Timeline Events
  documentEvents    DocumentEvent[]

  // Approval (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á)
  approvedBy String?
  approvedAt DateTime?

  // Tracking
  createdBy String
  creator   User     @relation("ExpenseCreator", fields: [createdBy], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?

  // ==========================================================================
  // Reimbursement Fields (‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
  // ==========================================================================
  isReimbursement Boolean @default(false) // ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

  // ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà createdBy)
  requesterId String?
  requester   User?   @relation("ReimbursementRequester", fields: [requesterId], references: [id])

  // Approval Workflow
  reimbursementStatus         ReimbursementStatus?
  reimbursementApprovedBy     String?
  reimbursementApprover       User?                @relation("ReimbursementApprover", fields: [reimbursementApprovedBy], references: [id])
  reimbursementApprovedAt     DateTime?
  reimbursementRejectedReason String?

  // Payout (‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô)
  reimbursementPaidAt     DateTime?
  reimbursementPaidBy     String?
  reimbursementPayer      User?     @relation("ReimbursementPayer", fields: [reimbursementPaidBy], references: [id])
  reimbursementPaymentRef String? // ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô

  // AI Fraud Detection
  fraudScore      Int?  // 0-100 (0=‡∏™‡∏∞‡∏≠‡∏≤‡∏î, 100=‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏°‡∏≤‡∏Å)
  fraudFlags      Json? // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà AI ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
  fraudAnalyzedAt DateTime?

  // Link from ReimbursementRequest (reverse relation)
  reimbursementRequest ReimbursementRequest?

  @@index([companyId, billDate])
  @@index([status])
  @@index([workflowStatus])
  @@index([accountId])
  @@index([contactId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([isReimbursement, reimbursementStatus])
  @@index([requesterId])
}


// Legacy status (keeping for backward compatibility)
enum ExpenseDocStatus {
  WAITING_FOR_DOC // üü† ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏≤
  PENDING_PHYSICAL // üî¥ ‡πÑ‡∏î‡πâ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß
  READY_TO_SEND // üü° ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏ã‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  SENT_TO_ACCOUNT // üü¢ ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
}

// =============================================================================
// NEW: Document Workflow Status (Timeline-based)
// =============================================================================

enum ExpenseWorkflowStatus {
  // Phase 1: Payment & Tax Invoice
  PAID                     // ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  WAITING_TAX_INVOICE      // ‡∏£‡∏≠‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô
  TAX_INVOICE_RECEIVED     // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  
  // Phase 2: WHT (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ isWht = true)
  WHT_PENDING_ISSUE        // ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥‡πÉ‡∏´‡πâ vendor
  WHT_ISSUED               // ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥‡πÅ‡∏•‡πâ‡∏ß
  WHT_SENT_TO_VENDOR       // ‡∏™‡πà‡∏á‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥‡πÉ‡∏´‡πâ vendor ‡πÅ‡∏•‡πâ‡∏ß
  
  // Phase 3: Accounting
  READY_FOR_ACCOUNTING     // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  SENT_TO_ACCOUNTANT       // ‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß
  COMPLETED                // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
}

enum IncomeWorkflowStatus {
  // Phase 1: Payment Received
  RECEIVED                 // ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
  
  // Phase 2: Invoice
  NO_INVOICE_NEEDED        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•
  WAITING_INVOICE_ISSUE    // ‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
  INVOICE_ISSUED           // ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß
  INVOICE_SENT             // ‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
  
  // Phase 3: WHT (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ isWhtDeducted = true)
  WHT_PENDING_CERT         // ‡∏£‡∏≠‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  WHT_CERT_RECEIVED        // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥‡πÅ‡∏•‡πâ‡∏ß
  
  // Phase 4: Accounting
  READY_FOR_ACCOUNTING     // ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  SENT_TO_ACCOUNTANT       // ‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß
  COMPLETED                // ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
}

// =============================================================================
// NEW: Document Event Types (Timeline events)
// =============================================================================

enum DocumentEventType {
  // Common
  CREATED                  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  UPDATED                  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  STATUS_CHANGED           // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  FILE_UPLOADED            // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
  FILE_REMOVED             // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
  NOTE_ADDED               // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
  
  // Tax Invoice
  TAX_INVOICE_REQUESTED    // ‡∏Ç‡∏≠‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô
  TAX_INVOICE_RECEIVED     // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö
  INVOICE_ISSUED           // ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  INVOICE_SENT             // ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  
  // WHT
  WHT_CERT_ISSUED          // ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  WHT_CERT_SENT            // ‡∏™‡πà‡∏á‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥‡πÉ‡∏´‡πâ vendor
  WHT_CERT_RECEIVED        // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  WHT_REMINDER_SENT        // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏ß‡∏á‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  
  // Accounting
  SENT_TO_ACCOUNTANT       // ‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  ACCOUNTANT_CONFIRMED     // ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö
}

// =============================================================================
// NEW: Document Event (Timeline)
// =============================================================================

model DocumentEvent {
  id          String            @id @default(cuid())
  
  // Link to transaction (one of these)
  expenseId   String?
  expense     Expense?          @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  incomeId    String?
  income      Income?           @relation(fields: [incomeId], references: [id], onDelete: Cascade)
  
  // Event details
  eventType   DocumentEventType
  eventDate   DateTime          @default(now())
  
  // Status change tracking
  fromStatus  String?           // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  toStatus    String?           // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  
  // Additional data
  notes       String?           @db.Text
  metadata    Json?             // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î, ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•, etc.)
  
  // Tracking
  createdBy   String
  creator     User              @relation("DocumentEventCreator", fields: [createdBy], references: [id])
  createdAt   DateTime          @default(now())
  
  @@index([expenseId])
  @@index([incomeId])
  @@index([eventType])
  @@index([eventDate])
}

// =============================================================================
// Reimbursement Status (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
// =============================================================================

enum ReimbursementStatus {
  PENDING // üü† ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  FLAGGED // üî¥ AI ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°
  APPROVED // üü¢ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô
  REJECTED // ‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
  PAID // ‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß
}

// =============================================================================
// ReimbursementRequest (‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) - ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Expense
// ‡∏™‡∏£‡πâ‡∏≤‡∏á Expense ‡πÄ‡∏°‡∏∑‡πà‡∏≠ PAID ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
// =============================================================================

model ReimbursementRequest {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Anonymous Requester Info
  requesterName   String  @default("") // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠
  requesterPhone  String? // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (optional)
  requesterEmail  String? // Email (optional)
  bankName        String  @default("") // ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  bankAccountNo   String  @default("") // ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  bankAccountName String  @default("") // ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ

  // Tracking Code (for public status check)
  trackingCode String? @unique

  // Financial Data
  amount    Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT
  vatRate   Int      @default(7)
  vatAmount Decimal? @db.Decimal(12, 2)
  netAmount Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô

  // Details
  description   String?
  contactId     String?
  contact       Contact?      @relation(fields: [contactId], references: [id])
  invoiceNumber String?
  paymentMethod PaymentMethod @default(CASH)
  billDate      DateTime      @default(now()) // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á

  // Evidence Files (receipts)
  receiptUrls Json @default("[]") // Array of receipt URLs

  // Status & Workflow
  status ReimbursementStatus @default(PENDING)

  // Approval
  approvedBy     String?
  approver       User?     @relation("ReimbursementApprovals", fields: [approvedBy], references: [id])
  approvedAt     DateTime?
  rejectedReason String?

  // Payout (‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô)
  paidAt     DateTime?
  paidBy     String?
  payer      User?   @relation("ReimbursementPayments", fields: [paidBy], references: [id])
  paymentRef String? // ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô

  // Link to Expense (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ PAID)
  linkedExpenseId String?  @unique
  linkedExpense   Expense? @relation(fields: [linkedExpenseId], references: [id])

  // AI Fraud Detection
  fraudScore      Int?      // 0-100
  fraudFlags      Json?     // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà AI ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
  fraudAnalyzedAt DateTime?

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, status])
  @@index([trackingCode])
  @@index([createdAt])
}

// =============================================================================
// Income (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö) - Enhanced
// =============================================================================

model Income {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Contact Information (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  contactName String? // ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (one-time contact)

  // Financial Data
  amount    Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT
  vatRate   Int      @default(0)
  vatAmount Decimal? @db.Decimal(12, 2)

  // WHT (‡πÄ‡∏Ç‡∏≤‡∏´‡∏±‡∏Å‡πÄ‡∏£‡∏≤)
  isWhtDeducted Boolean  @default(false)
  whtRate       Decimal? @db.Decimal(5, 2)
  whtAmount     Decimal? @db.Decimal(12, 2)
  whtType       WhtType?
  netReceived   Decimal  @db.Decimal(12, 2)

  // Document Details
  source        String? // ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤
  accountId     String?       // Chart of Accounts
  account       Account?      @relation(fields: [accountId], references: [id])
  invoiceNumber String? // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ
  referenceNo   String?
  paymentMethod PaymentMethod @default(BANK_TRANSFER)

  // Evidence Files (Supabase Storage URLs - Multiple Files)
  customerSlipUrls Json @default("[]") // Array of customer slip URLs
  myBillCopyUrls   Json @default("[]") // Array of bill copy URLs
  whtCertUrls      Json @default("[]") // Array of WHT cert URLs

  // Dates
  receiveDate DateTime @default(now())

  // Status & Workflow (Legacy)
  status IncomeDocStatus @default(PENDING_COPY_SEND)
  notes  String?         @db.Text

  // NEW: Workflow Status (Timeline-based)
  workflowStatus    IncomeWorkflowStatus @default(RECEIVED)
  
  // NEW: Document Checklist
  hasInvoice        Boolean   @default(false)  // ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß
  invoiceIssuedAt   DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•
  invoiceSentAt     DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  
  hasWhtCert        Boolean   @default(false)  // ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  whtCertReceivedAt DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  whtCertRemindedAt DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏ß‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  whtCertRemindCount Int      @default(0)       // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏ß‡∏á
  
  sentToAccountAt   DateTime?                   // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  
  // NEW: Timeline Events
  documentEvents    DocumentEvent[]

  // Job Order (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Phase 5 - Anajak)
  jobOrderId String?

  // Tracking
  createdBy String
  creator   User     @relation("IncomeCreator", fields: [createdBy], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?

  @@index([companyId, receiveDate])
  @@index([status])
  @@index([workflowStatus])
  @@index([accountId])
  @@index([contactId])
  @@index([createdAt])
  @@index([deletedAt])
}

enum IncomeDocStatus {
  NO_DOC_REQUIRED // ‚ö™ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  WAITING_ISSUE // üü† ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏¥‡∏•
  WAITING_WHT_CERT // üü† ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏£‡∏≠‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  PENDING_COPY_SEND // üî¥ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  SENT_COPY // üü¢ ‡∏™‡πà‡∏á‡∏õ‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß
}

// =============================================================================
// Shared Enums
// =============================================================================

enum PaymentMethod {
  CASH // ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
  BANK_TRANSFER // ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
  CREDIT_CARD // ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
  PROMPTPAY // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå
  CHEQUE // ‡πÄ‡∏ä‡πá‡∏Ñ
}

enum WhtType {
  SERVICE_3 // ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 3%
  PROFESSIONAL_5 // ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û 5%
  TRANSPORT_1 // ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á 1%
  RENT_5 // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ 5%
  ADVERTISING_2 // ‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ 2%
  OTHER // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
}

// =============================================================================
// Recurring Expenses (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥)
// =============================================================================

model RecurringExpense {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name         String // ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÇ‡∏Å‡∏î‡∏±‡∏á", "‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
  templateData Json // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Expense
  frequency    RecurrenceFreq
  amount       Decimal        @db.Decimal(12, 2)

  nextDueDate   DateTime
  lastCreatedAt DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, nextDueDate])
  @@index([isActive])
}

enum RecurrenceFreq {
  MONTHLY
  QUARTERLY
  YEARLY
}

// =============================================================================
// Integration Configuration
// =============================================================================

model Integration {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type           IntegrationType
  name           String // ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
  config         Json // API keys, endpoints, etc.
  isActive       Boolean         @default(true)
  lastSyncAt     DateTime?
  lastSyncStatus String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, type])
}

enum IntegrationType {
  ACCOUNTING_SOFTWARE // PEAK, Express
  BANK_STATEMENT // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  PAYMENT_GATEWAY // PromptPay
  LINE_NOTIFY
  GOOGLE_DRIVE // Backup
}

// =============================================================================
// Audit Log (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
// =============================================================================

model AuditLog {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id])
  companyId String? // ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filter logs ‡∏ï‡∏≤‡∏° company)

  action      AuditAction
  entityType  String // "Expense", "Income", etc.
  entityId    String
  changes     Json? // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (before/after)
  description String? // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  ipAddress   String?
  userAgent   String?

  createdAt DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  APPROVE
  EXPORT
}

// =============================================================================
// Vendor Mapping (AI Training Data)
// =============================================================================

model VendorMapping {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Transaction Type - ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
  // ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ mapping ‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö vs ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
  transactionType String // "EXPENSE" ‡∏´‡∏£‡∏∑‡∏≠ "INCOME"

  // Matching Criteria
  vendorName  String? // ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  vendorTaxId String? // Tax ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö match ‡πÅ‡∏ö‡∏ö exact
  namePattern String? // Regex pattern ‡πÄ‡∏ä‡πà‡∏ô "7-?Eleven.*"

  // Mapped Values
  contactId           String?
  contact             Contact?       @relation(fields: [contactId], references: [id])
  accountId           String?        // Chart of Accounts
  account             Account?       @relation(fields: [accountId], references: [id])
  defaultVatRate      Int? // 0 ‡∏´‡∏£‡∏∑‡∏≠ 7
  defaultWhtRate      Int? // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: 1, 2, 3, 5, 10, 15
  defaultWhtType      String? // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ: ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤, ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á, ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á, ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤
  paymentMethod       PaymentMethod?
  descriptionTemplate String? // ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å {vendorName}"

  // Stats
  useCount   Int       @default(0)
  lastUsedAt DateTime?

  // Learning metadata - NEW FIELDS
  learnSource  String? // "MANUAL" | "AUTO" | "FEEDBACK"
  originalTxId String? // Reference to transaction that created this mapping

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique per company + tax ID + transaction type
  // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô A ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ mapping ‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö EXPENSE ‡πÅ‡∏•‡∏∞ INCOME
  @@unique([companyId, vendorTaxId, transactionType])
  @@index([companyId, vendorName])
  @@index([companyId, transactionType])
}
