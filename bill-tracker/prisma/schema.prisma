// Bill Tracker & Mini-ERP System
// Database schema for Anajak T-Shirt & Meelike-th

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// Core Business Entities
// =============================================================================

model Company {
  id      String  @id @default(cuid())
  name    String // "Anajak T-Shirt", "Meelike-th"
  code    String  @unique // "ANJ", "MLK"
  taxId   String? // ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ
  address String?
  phone   String?
  logoUrl String?

  // LINE Bot Configuration
  lineChannelSecret      String?  // LINE Bot Channel Secret
  lineChannelAccessToken String?  // LINE Bot Channel Access Token
  lineGroupId            String?  // LINE Group ID (auto-filled by bot)
  lineNotifyEnabled      Boolean  @default(true) // Enable/disable LINE notifications
  lineNotifySettings     Json     @default("{}") // Detailed notification settings

  // AI Configuration
  aiConfig Json? // AI preferences and settings

  // Exchange Rates Configuration (currency code to THB rate)
  // Example: { "USD": 35.50, "AED": 9.65 }
  exchangeRates Json @default("{}") // Currency exchange rates to THB

  // Relations
  expenses              Expense[]
  incomes               Income[]
  users                 CompanyAccess[]
  contacts              Contact[]
  categories            Category[]
  integrations          Integration[]
  recurringExpenses     RecurringExpense[]
  vendorMappings        VendorMapping[]
  reimbursementRequests ReimbursementRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

// =============================================================================
// User Management with RBAC
// =============================================================================

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String
  password    String // hashed with bcrypt
  role        UserRole  @default(STAFF)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  avatarUrl   String?

  // Relations
  companies CompanyAccess[]
  expenses  Expense[]       @relation("ExpenseCreator")
  incomes   Income[]        @relation("IncomeCreator")
  auditLogs AuditLog[]

  // Reimbursement Relations (Legacy - for old Expense-based reimbursements)
  reimbursementRequests  Expense[] @relation("ReimbursementRequester")
  reimbursementApprovals Expense[] @relation("ReimbursementApprover")
  reimbursementPayments  Expense[] @relation("ReimbursementPayer")

  // New ReimbursementRequest Relations
  myReimbursementRequests       ReimbursementRequest[] @relation("ReimbursementRequests")
  myReimbursementApprovals      ReimbursementRequest[] @relation("ReimbursementApprovals")
  myReimbursementPayments       ReimbursementRequest[] @relation("ReimbursementPayments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

enum UserRole {
  ADMIN // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ
  ACCOUNTANT // ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ expense/income ‡πÑ‡∏î‡πâ
  STAFF // ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ
  VIEWER // ‡∏î‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
}

model CompanyAccess {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Custom Permission System
  isOwner     Boolean @default(false) // OWNER flag - ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
  permissions Json    @default("[]") // Custom permissions array: ["expenses:*", "incomes:read", ...]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

// =============================================================================
// Category (‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö)
// =============================================================================

model Category {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name      String // "‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö", "Custom Category"
  type      CategoryType // EXPENSE or INCOME
  isDefault Boolean      @default(false) // Is this a system default?
  isActive  Boolean      @default(true) // Can be toggled on/off
  color     String? // Optional hex color for UI
  icon      String? // Optional icon name
  order     Int          @default(0) // Display order

  // Hierarchy (2-level: Group ‚Üí Sub-category)
  parentId  String? // If null, this is a top-level group
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Category[] @relation("CategoryHierarchy")

  // Relations
  expenses              Expense[]
  incomes               Income[]
  vendorMappings        VendorMapping[]
  reimbursementRequests ReimbursementRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name, type])
  @@index([companyId, type])
  @@index([isActive])
  @@index([parentId])
}

enum CategoryType {
  EXPENSE
  INCOME
}

// =============================================================================
// Contact (‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ - ‡∏£‡∏ß‡∏° Vendor ‡πÅ‡∏•‡∏∞ Customer)
// =============================================================================

model Contact {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name    String
  taxId   String?
  address String?
  phone   String?
  email   String?

  // Banking
  bankAccount String?
  bankName    String?

  // Business Terms
  creditLimit  Decimal? @db.Decimal(12, 2)
  paymentTerms Int? // ‡∏ß‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï

  notes String?

  // Relations
  expenses              Expense[]
  incomes               Income[]
  vendorMappings        VendorMapping[]
  reimbursementRequests ReimbursementRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([name])
  @@index([taxId])
}

// =============================================================================
// Expense (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢) - Enhanced
// =============================================================================

model Expense {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Contact Information (‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  // Financial Data
  amount    Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT
  vatRate   Int      @default(7) // 7% ‡∏´‡∏£‡∏∑‡∏≠ 0%
  vatAmount Decimal? @db.Decimal(12, 2)

  // WHT (‡πÄ‡∏£‡∏≤‡∏´‡∏±‡∏Å‡πÄ‡∏Ç‡∏≤)
  isWht     Boolean  @default(false)
  whtRate   Decimal? @db.Decimal(5, 2) // 1, 2, 3, 5, 10
  whtAmount Decimal? @db.Decimal(12, 2)
  whtType   WhtType? // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ
  netPaid   Decimal  @db.Decimal(12, 2) // Amount + VAT - WHT

  // Document Details
  description   String?
  category      ExpenseCategory? // Legacy - use categoryId instead
  categoryId    String?
  categoryRef   Category?        @relation(fields: [categoryId], references: [id])
  invoiceNumber String? // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
  referenceNo   String? // ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á transaction
  paymentMethod PaymentMethod    @default(BANK_TRANSFER)

  // Evidence Files (Supabase Storage URLs - Multiple Files)
  slipUrls       Json @default("[]") // Array of slip URLs
  taxInvoiceUrls Json @default("[]") // Array of tax invoice URLs
  whtCertUrls    Json @default("[]") // Array of WHT cert URLs

  // Dates
  billDate DateTime  @default(now()) // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
  dueDate  DateTime? // ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)

  // Status & Workflow
  status ExpenseDocStatus @default(PENDING_PHYSICAL)
  notes  String?          @db.Text

  // Approval (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á)
  approvedBy String?
  approvedAt DateTime?

  // Tracking
  createdBy String
  creator   User     @relation("ExpenseCreator", fields: [createdBy], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?

  // ==========================================================================
  // Reimbursement Fields (‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
  // ==========================================================================
  isReimbursement Boolean @default(false) // ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

  // ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà createdBy)
  requesterId String?
  requester   User?   @relation("ReimbursementRequester", fields: [requesterId], references: [id])

  // Approval Workflow
  reimbursementStatus         ReimbursementStatus?
  reimbursementApprovedBy     String?
  reimbursementApprover       User?                @relation("ReimbursementApprover", fields: [reimbursementApprovedBy], references: [id])
  reimbursementApprovedAt     DateTime?
  reimbursementRejectedReason String?

  // Payout (‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô)
  reimbursementPaidAt     DateTime?
  reimbursementPaidBy     String?
  reimbursementPayer      User?     @relation("ReimbursementPayer", fields: [reimbursementPaidBy], references: [id])
  reimbursementPaymentRef String? // ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô

  // AI Fraud Detection
  fraudScore      Int?  // 0-100 (0=‡∏™‡∏∞‡∏≠‡∏≤‡∏î, 100=‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏°‡∏≤‡∏Å)
  fraudFlags      Json? // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà AI ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
  fraudAnalyzedAt DateTime?

  // Link from ReimbursementRequest (reverse relation)
  reimbursementRequest ReimbursementRequest?

  @@index([companyId, billDate])
  @@index([status])
  @@index([category])
  @@index([categoryId])
  @@index([contactId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([isReimbursement, reimbursementStatus])
  @@index([requesterId])
}

enum ExpenseCategory {
  MATERIAL // ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
  UTILITY // ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ
  MARKETING // ‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î
  SALARY // ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  FREELANCE // ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå
  TRANSPORT // ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á
  RENT // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤
  OFFICE // ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
  OTHER // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
}

enum ExpenseDocStatus {
  WAITING_FOR_DOC // üü† ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏°‡∏≤
  PENDING_PHYSICAL // üî¥ ‡πÑ‡∏î‡πâ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß
  READY_TO_SEND // üü° ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏ã‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  SENT_TO_ACCOUNT // üü¢ ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
}

// =============================================================================
// Reimbursement Status (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
// =============================================================================

enum ReimbursementStatus {
  PENDING // üü† ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  FLAGGED // üî¥ AI ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°
  APPROVED // üü¢ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô
  REJECTED // ‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
  PAID // ‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß
}

// =============================================================================
// ReimbursementRequest (‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) - ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Expense
// ‡∏™‡∏£‡πâ‡∏≤‡∏á Expense ‡πÄ‡∏°‡∏∑‡πà‡∏≠ PAID ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
// =============================================================================

model ReimbursementRequest {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
  requesterId String
  requester   User   @relation("ReimbursementRequests", fields: [requesterId], references: [id])

  // Financial Data
  amount    Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô VAT
  vatRate   Int      @default(7)
  vatAmount Decimal? @db.Decimal(12, 2)
  netAmount Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô

  // Details
  description   String?
  categoryId    String?
  categoryRef   Category?     @relation(fields: [categoryId], references: [id])
  contactId     String?
  contact       Contact?      @relation(fields: [contactId], references: [id])
  invoiceNumber String?
  paymentMethod PaymentMethod @default(CASH)
  billDate      DateTime      @default(now()) // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á

  // Evidence Files (receipts)
  receiptUrls Json @default("[]") // Array of receipt URLs

  // Status & Workflow
  status ReimbursementStatus @default(PENDING)

  // Approval
  approvedBy     String?
  approver       User?     @relation("ReimbursementApprovals", fields: [approvedBy], references: [id])
  approvedAt     DateTime?
  rejectedReason String?

  // Payout (‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô)
  paidAt     DateTime?
  paidBy     String?
  payer      User?   @relation("ReimbursementPayments", fields: [paidBy], references: [id])
  paymentRef String? // ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô

  // Link to Expense (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ PAID)
  linkedExpenseId String?  @unique
  linkedExpense   Expense? @relation(fields: [linkedExpenseId], references: [id])

  // AI Fraud Detection
  fraudScore      Int?      // 0-100
  fraudFlags      Json?     // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà AI ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö
  fraudAnalyzedAt DateTime?

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, status])
  @@index([requesterId])
  @@index([createdAt])
}

// =============================================================================
// Income (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö) - Enhanced
// =============================================================================

model Income {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Contact Information (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  // Financial Data
  amount    Decimal  @db.Decimal(12, 2) // ‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏Å‡πà‡∏≠‡∏ô VAT
  vatRate   Int      @default(0)
  vatAmount Decimal? @db.Decimal(12, 2)

  // WHT (‡πÄ‡∏Ç‡∏≤‡∏´‡∏±‡∏Å‡πÄ‡∏£‡∏≤)
  isWhtDeducted Boolean  @default(false)
  whtRate       Decimal? @db.Decimal(5, 2)
  whtAmount     Decimal? @db.Decimal(12, 2)
  whtType       WhtType?
  netReceived   Decimal  @db.Decimal(12, 2)

  // Document Details
  source        String? // ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤
  categoryId    String?
  categoryRef   Category?     @relation(fields: [categoryId], references: [id])
  invoiceNumber String? // ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ
  referenceNo   String?
  paymentMethod PaymentMethod @default(BANK_TRANSFER)

  // Evidence Files (Supabase Storage URLs - Multiple Files)
  customerSlipUrls Json @default("[]") // Array of customer slip URLs
  myBillCopyUrls   Json @default("[]") // Array of bill copy URLs
  whtCertUrls      Json @default("[]") // Array of WHT cert URLs

  // Dates
  receiveDate DateTime @default(now())

  // Status & Workflow
  status IncomeDocStatus @default(PENDING_COPY_SEND)
  notes  String?         @db.Text

  // Job Order (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Phase 5 - Anajak)
  jobOrderId String?

  // Tracking
  createdBy String
  creator   User     @relation("IncomeCreator", fields: [createdBy], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft Delete
  deletedAt DateTime?
  deletedBy String?

  @@index([companyId, receiveDate])
  @@index([status])
  @@index([categoryId])
  @@index([contactId])
  @@index([createdAt])
  @@index([deletedAt])
}

enum IncomeDocStatus {
  NO_DOC_REQUIRED // ‚ö™ ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  WAITING_ISSUE // üü† ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏¥‡∏•
  WAITING_WHT_CERT // üü† ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏£‡∏≠‡πÉ‡∏ö 50 ‡∏ó‡∏ß‡∏¥
  PENDING_COPY_SEND // üî¥ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö ‡∏£‡∏≠‡∏™‡πà‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  SENT_COPY // üü¢ ‡∏™‡πà‡∏á‡∏õ‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß
}

// =============================================================================
// Shared Enums
// =============================================================================

enum PaymentMethod {
  CASH // ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
  BANK_TRANSFER // ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
  CREDIT_CARD // ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
  PROMPTPAY // ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå
  CHEQUE // ‡πÄ‡∏ä‡πá‡∏Ñ
}

enum WhtType {
  SERVICE_3 // ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 3%
  PROFESSIONAL_5 // ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û 5%
  TRANSPORT_1 // ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á 1%
  RENT_5 // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ 5%
  ADVERTISING_2 // ‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ 2%
  OTHER // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
}

// =============================================================================
// Recurring Expenses (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥)
// =============================================================================

model RecurringExpense {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name         String // ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÇ‡∏Å‡∏î‡∏±‡∏á", "‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
  templateData Json // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Expense
  frequency    RecurrenceFreq
  amount       Decimal        @db.Decimal(12, 2)

  nextDueDate   DateTime
  lastCreatedAt DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, nextDueDate])
  @@index([isActive])
}

enum RecurrenceFreq {
  MONTHLY
  QUARTERLY
  YEARLY
}

// =============================================================================
// Integration Configuration
// =============================================================================

model Integration {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type           IntegrationType
  name           String // ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
  config         Json // API keys, endpoints, etc.
  isActive       Boolean         @default(true)
  lastSyncAt     DateTime?
  lastSyncStatus String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, type])
}

enum IntegrationType {
  ACCOUNTING_SOFTWARE // PEAK, Express
  BANK_STATEMENT // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  PAYMENT_GATEWAY // PromptPay
  LINE_NOTIFY
  GOOGLE_DRIVE // Backup
}

// =============================================================================
// Audit Log (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
// =============================================================================

model AuditLog {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id])
  companyId String? // ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filter logs ‡∏ï‡∏≤‡∏° company)

  action      AuditAction
  entityType  String // "Expense", "Income", etc.
  entityId    String
  changes     Json? // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (before/after)
  description String? // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  ipAddress   String?
  userAgent   String?

  createdAt DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  APPROVE
  EXPORT
}

// =============================================================================
// Vendor Mapping (AI Training Data)
// =============================================================================

model VendorMapping {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Transaction Type - ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
  // ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ mapping ‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö vs ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
  transactionType CategoryType // EXPENSE ‡∏´‡∏£‡∏∑‡∏≠ INCOME

  // Matching Criteria
  vendorName  String? // ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  vendorTaxId String? // Tax ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö match ‡πÅ‡∏ö‡∏ö exact
  namePattern String? // Regex pattern ‡πÄ‡∏ä‡πà‡∏ô "7-?Eleven.*"

  // Mapped Values
  contactId           String?
  contact             Contact?       @relation(fields: [contactId], references: [id])
  categoryId          String?
  category            Category?      @relation(fields: [categoryId], references: [id])
  defaultVatRate      Int? // 0 ‡∏´‡∏£‡∏∑‡∏≠ 7
  paymentMethod       PaymentMethod?
  descriptionTemplate String? // ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å {vendorName}"

  // Stats
  useCount   Int       @default(0)
  lastUsedAt DateTime?

  // Learning metadata - NEW FIELDS
  learnSource  String? // "MANUAL" | "AUTO" | "FEEDBACK"
  originalTxId String? // Reference to transaction that created this mapping

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique per company + tax ID + transaction type
  // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô A ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ mapping ‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö EXPENSE ‡πÅ‡∏•‡∏∞ INCOME
  @@unique([companyId, vendorTaxId, transactionType])
  @@index([companyId, vendorName])
  @@index([companyId, transactionType])
}
